# 代理

您可以将一个Runnable传递给代理。

从Runnable构建代理通常涉及以下几个方面：

1. 数据处理中间步骤（`agent_scratchpad`）。这些数据需要以语言模型能够识别的方式表示出来。这应该与提示中的指令密切相关。因此，在下面的XML代理示例中，我们使用内置的util `formatXml` 将步骤格式化为XML。

2. 提示本身。下面是默认的XML代理提示，其中包括工具列表和用户问题的变量。它还包含代理需要学习的输入和输出的示例。

3. 模型，如果需要的话，包括停止令牌（在我们的案例中是需要的）。

4. 输出解析器 - 应该与提示指定的格式一致。在我们的案例中，我们将继续使用XML主题并使用默认的`XMLAgentOutputParser`。

import IntegrationInstallTooltip from "@mdx\_components/integration\_install\_tooltip.mdx";

<IntegrationInstallTooltip></IntegrationInstallTooltip>

```bash npm2yarn
npm install @langchain/anthropic
```

```typescript
import { ChatAnthropic } from "@langchain/anthropic";
import { AgentExecutor } from "langchain/agents";
import { formatXml } from "langchain/agents/format_scratchpad/xml";
import { XMLAgentOutputParser } from "langchain/agents/xml/output_parser";
import { ChatPromptTemplate } from "langchain/prompts";
import { AgentStep } from "langchain/schema";
import { RunnableSequence } from "langchain/schema/runnable";
import { Tool, ToolParams } from "langchain/tools";
import { renderTextDescription } from "langchain/tools/render";
```

```typescript
// 定义带有停止令牌的模型。
const model = new ChatAnthropic({ temperature: 0 }).bind({
  stop: ["</tool_input>", "</final_answer>"],
});
```

为了简单起见，我们将为这个示例定义一个自定义工具。您可以使用我们的内置工具，或者按照您下面看到的格式自行定义工具。

```typescript
class SearchTool extends Tool {
  static lc_name() {
    return "SearchTool";
  }

  name = "search-tool";

  description = "This tool preforms a search about things and whatnot.";

  constructor(config?: ToolParams) {
    super(config);
  }

  async _call(_: string) {
    return "32 degrees";
  }
}

const tools = [new SearchTool()];
```

```typescript
const template = `You are a helpful assistant. Help the user answer any questions.

You have access to the following tools:

{tools}

In order to use a tool, you can use <tool></tool> and <tool_input></tool_input> tags. \
You will then get back a response in the form <observation></observation>
For example, if you have a tool called 'search' that could run a google search, in order to search for the weather in SF you would respond:

<tool>search</tool><tool_input>weather in SF</tool_input>
<observation>64 degrees</observation>

When you are done, respond with a final answer between <final_answer></final_answer>. For example:

<final_answer>The weather in SF is 64 degrees</final_answer>

Begin!

Question: {input}`;
```

```typescript
const prompt = ChatPromptTemplate.fromMessages([
  ["human", template],
  ["ai", "{agent_scratchpad}"],
]);

const outputParser = new XMLAgentOutputParser();
```

```typescript
const runnableAgent = RunnableSequence.from([
  {
    input: (i: { input: string; tools: Tool[]; steps: AgentStep[] }) => i.input,
    tools: (i: { input: string; tools: Tool[]; steps: AgentStep[] }) =>
      renderTextDescription(i.tools),
    agent_scratchpad: (i: {
      input: string;
      tools: Tool[];
      steps: AgentStep[];
    }) => formatXml(i.steps),
  },
  prompt,
  model,
  outputParser,
]);
```

```typescript
const executor = AgentExecutor.fromAgentAndTools({
  agent: runnableAgent,
  tools,
});
```

```typescript
console.log("Executor loaded");

const input = "What is the weather in SF?";
console.log(`Calling executor with input: ${input}`);
const response = await executor.invoke({ input, tools });
console.log(response);
```

```txt
Executor loaded
Calling executor with input: What is the weather in SF?
{ output: 'The weather in SF is 32 degrees' }
```


