# 添加消息历史（记忆）

`RunnableWithMessageHistory` 允许我们将消息历史添加到某些类型的链中。

具体来说，它可以用于任何Runnable，该Runnable接受以下输入之一：

- `BaseMessage` 的序列
- 一个字典，其中包含一个键，该键接受 `BaseMessage` 的序列
- 一个字典，其中一个键接受最新消息（作为字符串或 `BaseMessage` 的序列），另一个键接受历史消息

并返回以下输出之一：

- 可以被视为 `AIMessage` 内容的字符串
- `BaseMessage` 的序列
- 一个字典，其中包含一个键，该键包含 `BaseMessage` 的序列

让我们看一些例子来了解它的工作原理。

## 设置

我们将使用 Upstash 来存储我们的聊天消息历史，并使用 Anthropic 的 claude-2 模型，因此我们需要安装以下依赖项：

```bash npm2yarn
npm install @langchain/anthropic @langchain/community @upstash/redis
```

您需要设置 `ANTHROPIC_API_KEY` 的环境变量，并获取您的 Upstash REST url 和 secret token。

### [LangSmith](https://smith.langchain.com/)

LangSmith 在处理消息历史注入之类的事情时特别有用，否则很难理解各种链的输入。

请注意，LangSmith 不是必需的，但它很有帮助。
如果您确实想使用 LangSmith，在上述链接注册后，请确保取消注释下面的内容，并设置您的环境变量以开始记录跟踪：

```bash
export LANGCHAIN_TRACING_V2="true"
export LANGCHAIN_API_KEY="<your-api-key>"
```

## 示例：字典输入，消息输出

让我们创建一个简单的链，它接受字典作为输入并返回 BaseMessage。

在这种情况下，输入中的 `"question"` 键代表我们的输入消息，而 `"history"` 键是我们将注入历史消息的地方。

```typescript
import {
  ChatPromptTemplate,
  MessagesPlaceholder,
} from "@langchain/core/prompts";
import { ChatAnthropic } from "@langchain/anthropic";
import { UpstashRedisChatMessageHistory } from "@langchain/community/stores/message/upstash_redis";
// 对于演示，您也可以使用内存存储：
// import { ChatMessageHistory } from "langchain/stores/message/in_memory";

const prompt = ChatPromptTemplate.fromMessages([
  ["system", "你是一个擅长{ability}的助手"],
  new MessagesPlaceholder("history"),
  ["human", "{question}"],
]);

const chain = prompt.pipe(
  new ChatAnthropic({ modelName: "claude-3-sonnet-20240229" })
);
```

### 添加消息历史

要将消息历史添加到我们原始的链中，我们将其包裹在 `RunnableWithMessageHistory` 类中。

关键是我们还需要定义一个方法，该方法接受一个 `sessionId` 字符串，并基于它返回一个 `BaseChatMessageHistory`。对于相同的输入，这个方法应该返回一个等价输出。

在这种情况下，我们还希望指定 `inputMessagesKey`（被视为最新输入消息的键）和 `historyMessagesKey`（添加历史消息的键）。

```typescript
import { RunnableWithMessageHistory } from "@langchain/core/runnables";

const chainWithHistory = new RunnableWithMessageHistory({
  runnable: chain,
  getMessageHistory: (sessionId) =>
    new UpstashRedisChatMessageHistory({
      sessionId,
      config: {
        url: process.env.UPSTASH_REDIS_REST_URL!,
        token: process.env.UPSTASH_REDIS_REST_TOKEN!,
      },
    }),
  inputMessagesKey: "question",
  historyMessagesKey: "history",
});
```

## 使用配置调用

每当我们调用具有消息历史的链时，我们需要包含一个额外的配置对象，其中包含 `session_id`

```typescript
{
  configurable: {
    sessionId: "<SESSION_ID>";
  }
}
```

给定相同的配置，我们的链应该从相同的聊天消息历史中提取。

```typescript
const result = await chainWithHistory.invoke(
  {
    ability: "math",
    question: "余弦是什么意思？",
  },
  {
    configurable: {
      sessionId: "foobarbaz",
    },
  }
);

console.log(result);

/*
  AIMessage {
    content: '余弦是指基本三角函数之一。具体来说：\n' +
      '\n' +
      '- 余弦是三个主要三角函数之一，与正弦和正切并列。它通常缩写为 cos。\n' +
      '\n' +
      '- 对于一个直角三角形，其边长为 a、b 和 c（其中 c 是斜边），余弦表示邻边（a）的长度与斜边（c）的长度的比率。所以 cos(A) = a/c，其中 A 是边 a 对应的角。\n' +
      '\n' +
      '- 在笛卡尔平面上，余弦表示单位圆上给定
```

请注意，上述代码块中的翻译是根据您提供的上下文进行的，但代码块中的内容（包括变量名和函数名）通常不翻译，因为它们是技术术语，通常保持原样以便于开发者理解和使用。

