---
sidebar_position: 2
---

import CodeBlock from "@theme/CodeBlock";

# 接口
为了尽可能简化创建自定义链的过程，我们实现了一个["Runnable"](https://api.js.langchain.com/classes/langchain_core_runnables.Runnable.html)协议，大多数组件都实现了这个协议。这是一个标准接口，具有几种不同的方法，可以轻松定义自定义链，同时也使得以标准方式调用它们成为可能。公开的标准接口包括：

这是一个具有几种不同方法的标准接口，可以轻松定义自定义链，并使以标准方式调用它们成为可能。公开的标准接口包括：

- [`stream`](/docs/expression_language/interface#stream): 将响应的块流式返回
- [`invoke`](/docs/expression_language/interface#invoke): 使用输入调用链
- [`batch`](/docs/expression_language/interface#batch): 使用输入列表调用链
- [`streamLog`](/docs/expression_language/interface#stream-log): 流回发生的中间步骤以及最终响应
- [`streamEvents`](/docs/expression_language/interface#stream-events): **新版**，以链中发生的事件流式返回（在 `@langchain/core` 0.1.27 中引入）

**输入类型**因组件而异：

| 组件      | 输入类型                                         |
| -------------- | --------------------------------------------------- |
| Prompt         | Object                                              |
| Retriever      | Single string                                       |
| LLM, ChatModel | Single string, list of chat messages or PromptValue |
| Tool           | Single string, or object, depending on the tool     |
| OutputParser   | The output of an LLM or ChatModel                   |

**输出类型**也因组件而异：

| 组件    | 输出类型          |
| ------------ | --------------------- |
| LLM          | String                |
| ChatModel    | ChatMessage           |
| Prompt       | PromptValue           |
| Retriever    | List of documents     |
| Tool         | Depends on the tool   |
| OutputParser | Depends on the parser |


您可以以两种方式将可运行对象（以及类似可运行对象的函数和其值全为函数的对象）组合成序列：

- 调用 `.pipe` 实例方法，该方法接受另一个类似可运行的对象作为参数
- 使用 `RunnableSequence.from([])` 静态方法，并传入一个类似可运行的数组，这些将在调用时按顺序运行

下面是这些示例的样子。
## 流

import StreamExample from "@examples/guides/expression_language/interface_stream.ts";

import IntegrationInstallTooltip from "@mdx_components/integration_install_tooltip.mdx";

<IntegrationInstallTooltip></IntegrationInstallTooltip>

```bash npm2yarn
npm install @langchain/openai
```

<CodeBlock language="typescript">{StreamExample}</CodeBlock>

## 插入

import InvokeExample from "@examples/guides/expression_language/interface_invoke.ts";

<CodeBlock language="typescript">{InvokeExample}</CodeBlock>

## 批量

import BatchExample from "@examples/guides/expression_language/interface_batch.ts";

<CodeBlock language="typescript">{BatchExample}</CodeBlock>

你也可以传递额外的参数给调用。标准的 LCEL 配置对象包含一个设置最大并发数的选项，
以及一个特定的 `batch()` 配置对象，其中包括一个选项，用于确定是否返回异常而不是抛出它们（这对于优雅地处理失败很有用！）：

import BatchExampleWithOptions from "@examples/guides/expression_language/interface_batch_with_options.ts";

<CodeBlock language="typescript">{BatchExampleWithOptions}</CodeBlock>


## 流日志

所有可运行对象也有一个 `.streamLog()` 方法，用于流回链/序列的所有或部分中间步骤。

这用于显示进度给用户，使用中间结果，或调试你的链。
你可以流回所有步骤（默认）或根据名称、标签或元数据包含/排除步骤。

这个方法产生 [JSONPatch](https://jsonpatch.com/) 操作，当按照接收到的顺序应用时，会构建起 RunState。

要使用 JSONPatches 重建为单个 JSON 对象，你可以使用 [`applyPatch`](https://api.js.langchain.com/functions/langchain_core_utils_json_patch.applyPatch.html) 方法。
下面的示例演示了如何将补丁传递给 `applyPatch` 方法。

这是一个流回检索链中间文档的示例：

import StreamLogExample from "@examples/guides/expression_language/interface_stream_log.ts";

```bash npm2yarn
npm install @langchain/community @langchain/openai
```

<CodeBlock language="typescript">{StreamLogExample}</CodeBlock>


## 流事件

事件流是一个 **新版** API，可能会根据反馈进行一些更改。它提供了一种从链中流式传输中间步骤和最终输出的方法。

注意：在 `@langchain/core` 0.1.27 中引入

现在，使用 `streamEvents` API 时，为了使一切正常工作，请：

- 任何自定义函数/可运行对象必须传播回调
- 设置模型的正确参数以强制LLM流式传输标记

### 事件引用

这里是一个参考表，显示了各种 Runnable 对象可能发出的一些事件。
表后包含了某些 Runnable 的定义。

⚠️ 在流式传输输入时，直到输入流被完全消耗之前，可运行对象的输入将不可用。这意味着输入将在相应的`结束`钩子处可用，而不是在`开始`事件时可用。

| event                | name             | chunk                           | input                                         | output                                          |
| -------------------- | ---------------- | ------------------------------- | --------------------------------------------- | ----------------------------------------------- |
| on_chat_model_start  | [model name]     |                                 | {"messages": [[SystemMessage, HumanMessage]]} |                                                 |
| on_chat_model_stream | [model name]     | AIMessageChunk(content="hello") |                                               |                                                 |
| on_chat_model_end    | [model name]     |                                 | {"messages": [[SystemMessage, HumanMessage]]} | {"generations": [...], "llm_output": None, ...} |
| on_llm_start         | [model name]     |                                 | {'input': 'hello'}                            |                                                 |
| on_llm_stream        | [model name]     | 'Hello'                         |                                               |                                                 |
| on_llm_end           | [model name]     |                                 | 'Hello human!'                                |
| on_chain_start       | format_docs      |                                 |                                               |                                                 |
| on_chain_stream      | format_docs      | "hello world!, goodbye world!"  |                                               |                                                 |
| on_chain_end         | format_docs      |                                 | [Document(...)]                               | "hello world!, goodbye world!"                  |
| on_tool_start        | some_tool        |                                 | {"x": 1, "y": "2"}                            |                                                 |
| on_tool_stream       | some_tool        | {"x": 1, "y": "2"}              |                                               |                                                 |
| on_tool_end          | some_tool        |                                 |                                               | {"x": 1, "y": "2"}                              |
| on_retriever_start   | [retriever name] |                                 | {"query": "hello"}                            |                                                 |
| on_retriever_chunk   | [retriever name] | {documents: [...]}              |                                               |                                                 |
| on_retriever_end     | [retriever name] |                                 | {"query": "hello"}                            | {documents: [...]}                              |
| on_prompt_start      | [template_name]  |                                 | {"question": "hello"}                         |                                                 |
| on_prompt_end        | [template_name]  |                                 | {"question": "hello"}                         | ChatPromptValue(messages: [SystemMessage, ...]) |

import StreamEventsExample from "@examples/agents/stream_events.ts";

<CodeBlock language="typescript">{StreamEventsExample}</CodeBlock>

```
-----
Starting agent: Agent with input: {"input":"what is the weather in SF"}

-----
Starting tool: TavilySearchResults with inputs: weather in San Francisco

-----
Finished tool: TavilySearchResults

Tool output was: [{"title":"Weather in San Francisco","url":"https://www.weatherapi.com/","content":"Weather in San Francisco is {'location': {'name': 'San Francisco', 'region': 'California', 'country': 'United States of America', 'lat': 37.78, 'lon': -122.42, 'tz_id': 'America/Los_Angeles', 'localtime_epoch': 1707638479, 'localtime': '2024-02-11 0:01'}, 'current': {'last_updated_epoch': 1707638400, 'last_updated': '2024-02-11 00:00', 'temp_c': 11.1, 'temp_f': 52.0, 'is_day': 0, 'condition': {'text': 'Partly cloudy', 'icon': '//cdn.weatherapi.com/weather/64x64/night/116.png', 'code': 1003}, 'wind_mph': 9.4, 'wind_kph': 15.1, 'wind_degree': 270, 'wind_dir': 'W', 'pressure_mb': 1022.0, 'pressure_in': 30.18, 'precip_mm': 0.0, 'precip_in': 0.0, 'humidity': 83, 'cloud': 25, 'feelslike_c': 11.5, 'feelslike_f': 52.6, 'vis_km': 16.0, 'vis_miles': 9.0, 'uv': 1.0, 'gust_mph': 13.9, 'gust_kph': 22.3}}","score":0.98371,"raw_content":null},{"title":"San Francisco, California November 2024 Weather Forecast","url":"https://www.weathertab.com/en/c/e/11/united-states/california/san-francisco/","content":"Temperature Forecast Temperature Forecast Normal Avg High Temps 60 to 70 °F Avg Low Temps 45 to 55 °F Weather Forecast Legend WeatherTAB helps you plan activities on days with the least risk of rain. Our forecasts are not direct predictions of rain/snow. Not all risky days will have rain/snow.","score":0.9517,"raw_content":null},{"title":"Past Weather in San Francisco, California, USA — Yesterday or Further Back","url":"https://www.timeanddate.com/weather/usa/san-francisco/historic","content":"Past Weather in San Francisco, California, USA — Yesterday and Last 2 Weeks. Weather. Time Zone. DST Changes. Sun & Moon. Weather Today Weather Hourly 14 Day Forecast Yesterday/Past Weather Climate (Averages) Currently: 52 °F. Light rain. Overcast.","score":0.945,"raw_content":null},{"title":"San Francisco, California February 2024 Weather Forecast - detailed","url":"https://www.weathertab.com/en/g/e/02/united-states/california/san-francisco/","content":"Free Long Range Weather Forecast for San Francisco, California February 2024. Detailed graphs of monthly weather forecast, temperatures, and degree days.","score":0.92177,"raw_content":null},{"title":"San Francisco Weather in 2024 - extremeweatherwatch.com","url":"https://www.extremeweatherwatch.com/cities/san-francisco/year-2024","content":"Year: What's the hottest temperature in San Francisco so far this year? As of February 2, the highest temperature recorded in San Francisco, California in 2024 is 73 °F which happened on January 29. Highest Temperatures: All-Time By Year Highest Temperatures in San Francisco in 2024 What's the coldest temperature in San Francisco so far this year?","score":0.91598,"raw_content":null}]

-----
| The
|  current
|  weather
|  in
|  San
|  Francisco
|  is
|  partly
|  cloudy
|  with
|  a
|  temperature
|  of
|
| 52
| .
| 0
| °F
|  (
| 11
| .
| 1
| °C
| ).
|  The
|  wind
|  speed
|  is
|
| 15
| .
| 1
|  k
| ph
|  coming
|  from
|  the
|  west
| ,
|  and
|  the
|  humidity
|  is
|  at
|
| 83
| %.
|  If
|  you
|  need
|  more
|  detailed
|  information
| ,
|  you
|  can
|  visit
|  [
| Weather
|  in
|  San
|  Francisco
| ](
| https
| ://
| www
| .weather
| api
| .com
| /
| ).

-----
Finished agent: Agent

Agent output was: The current weather in San Francisco is partly cloudy with a temperature of 52.0°F (11.1°C). The wind speed is 15.1 kph coming from the west, and the humidity is at 83%. If you need more detailed information, you can visit [Weather in San Francisco](https://www.weatherapi.com/).

-----
```
